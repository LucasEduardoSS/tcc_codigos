esphome:
  name: esphome-web-1100cc
  friendly_name: ESPHome
  min_version: 2025.9.0
  name_add_mac_suffix: false

esp32:
  variant: esp32
  framework:
    type: esp-idf

# Enable logging
logger:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Esp32 Fallback Hotspot"
    password: "8b9lRsaC0tKv"

api:
  encryption:
    key: "ngOcUWeNZtrRN8FC4BA5YHcMof/w3UnKeJvbKNTjZg8="

ota:
  - platform: esphome
    password: "a43b9fcd4f48f79ecf7fd73b8d3ecf53"


# --- I2C comunication pins ---
i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true
  id: bus_a


# --- Thresholds ---
number:
  - platform: homeassistant
    entity_id: input_number.humidity_threshold
    id: humidity_threshold

  - platform: homeassistant
    entity_id: input_number.light_threshold
    id: light_threshold
	
  - platform: homeassistant
    entity_id: input_number.temperature_threshold
    id: temperature_threshold

# --- Auto mode from HA ---
binary_sensor:
  - platform: homeassistant
    entity_id: input_boolean.auto_mode
    id: auto_mode


sensor:
  # AHT10 (AHT20) – Temperature & Humidity
  - platform: aht10
    i2c_id: bus_a   
    variant: AHT20    
    address: 0x38
    temperature:
      name: "Bedroom Temperature"
      id: "temperature_sensor"
      unit_of_measurement: "°C"
      accuracy_decimals: 1
      device_class: temperature
      state_class: measurement
    humidity:
      name: "Bedroom Humidity"
      id: "humidity_sensor"
      unit_of_measurement: "%"
      accuracy_decimals: 1
      device_class: humidity
      state_class: measurement
    update_interval: 30s

  # BH1750 - Light
  - platform: bh1750
    i2c_id: bus_a
    name: "Bedroom Illuminance"
    id: "light_sensor"
    address: 0x23   
    update_interval: 30s

  # Relay 1: reacts to humidity
  - platform: template
    id: humidity_logic
    internal: true
    lambda: |-
      return id(humidity_sensor).state;
    on_value_range:
      - above: !lambda "return id(humidity_threshold).state + 2;"
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_off: relay_control_1
      - below: !lambda "return id(humidity_threshold).state - 2;"
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_on: relay_control_1

  # Relay 2: reacts to brightness
  - platform: template
    id: light_logic
    internal: true
    lambda: |-
      return id(light_sensor).state;
    on_value_range:
      - above: !lambda "return id(light_threshold).state + 5;"     
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_off: relay_control_2
      - below: !lambda "return id(light_threshold).state - 5;"
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_on: relay_control_2

  # IR Emitter: reacts to temperature  TERMINAR DE CONFIGURAR
  - platform: template
    id: temperature_logic
    internal: true
    lambda: |-
      return id(temperature_sensor).state;
    on_value_range:
      - above: !lambda "return id(temperature_threshold).state + 2;"
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_off: relay_control_1
      - below: !lambda "return id(temperature_threshold).state - 2;"
        then:
          - if:
              condition:
                lambda: "return id(auto_mode).state;"
              then:
                - switch.turn_on: relay_control_1


# --- IR receiver --
remote_receiver:
  pin:
    number: GPIO15
    inverted: true
    mode:
      input: true
      pullup: true
  dump: all  
  filter: 50us  # filter out noise pulses shorter than 50us
  idle: 4ms

# --- IR Emitter
remote_transmitter:
  pin: GPIO4
  carrier_duty_percent: 50%  # standard 38 kHz modulation

 
switch:
  # --- Testisng switch that sends NEC code (like a remote button) ---
  - platform: template
    name: "Send NEC Power Command"
    turn_on_action:
      remote_transmitter.transmit_nec:
        address: 0x10
        command: 0x20

  # --- Relay 1 testing switch ---
  - platform: template
    name: "Relay Control 1"
    id: relay_control_1
    icon: "mdi:power"
    turn_on_action:
      - output.turn_on: relay_output_1
    turn_off_action:
      - output.turn_off: relay_output_1

  # --- Relay 2 testing switch ---
  - platform: template
    name: "Relay Control 2"
    id: relay_control_2
    icon: "mdi:power"
    turn_on_action:
      - output.turn_on: relay_output_2
    turn_off_action:
      - output.turn_off: relay_output_2

# --- Relay output ---
output:
  - platform: gpio
    pin: GPIO26
    id: relay_output_1
    inverted: True    # For active-LOW relay boards

  - platform: gpio
    pin: GPIO25
    id: relay_output_2
    inverted: True    # For active-LOW relay boards
  